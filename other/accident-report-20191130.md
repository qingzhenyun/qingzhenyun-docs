## 2019年11月30日服务中断事故报告

* 简体中文
* 本报告仅提供简体中文
* 报告时间 2019-12-01 14:09

#### 概要

北京时间(GMT+8)2019年11月30日晚6点左右至 2019年12月1日 2:30 分，网站主站集群停止运行，服务中断。

#### 事故原因

* etcd 证书过期
* kubernetes 证书过期
* istio证书过期
* master节点和slave节点kubernetes版本不一致
* master节点上systemd-resolve故障

#### 事故详细经过

| 时间                |                    操作                   |
|---------------------|:-----------------------------------------:|
| 2019-11-30 18:29:08 |              etcd证书开始过期             |
| 2019-11-30 18:40:32 |                etcd服务终止               |
| 2019-11-30 19:20:11 |         部分kubernetes pod开始故障        |
| 2019-11-30 20:29:16 | kubernetes api server故障，监控开始报障   |
| 2019-11-30 21:05:13 | kubernetes master节点退出，集群完全不可用 |
| 2019-11-30 21:39:11 | 核实服务出现问题，于zw-14查看原因         |
| 2019-11-30 21:54:22 | 核实kubernetes退出服务                    |
| 2019-11-30 22:15:12 | 定位到证书过期，GMT 10:29:08              |
| 2019-11-30 22:37:10 | 重新签证书并导入，尝试重启集群失败        |
| 2019-11-30 23:12:56 | 服务重启成功，POD均转入running状态        |
| 2019-11-30 23:21:48 | 服务再次退出，nginx端报告502              |
| 2019-12-01 00:38:32 | 替换所有证书，重启集群无效                |
| 2019-12-01 01:05:43 | 准备导出老集群配置，于v3集群上运行        |
| 2019-12-01 01:11:29 | master仍然无法服务。但业务已经正常        |
| 2019-12-01 01:17:51 | kubelet加不进自己的集群，RBAC错误         |
| 2019-12-01 01:21:11 | 核实istio启动不成功                       |
| 2019-12-01 01:34:22 | 尝试更新istio证书                         |
| 2019-12-01 02:19:10 | 重新签根证书                              |
| 2019-12-01 02:21:08 | 修复本地DNS错误                           |
| 2019-12-01 02:25:16 | istio重启成功                             |
| 2019-12-01 02:28:11 | master加入集群成功                        |
| 2019-12-01 02:36:51 | 核实istio进入正常状态                     |
| 2019-12-01 02:38:01 | 核实网站功能正常                          |

#### 事故原因分析

1. openssl 库签出证书是一年过期
2. kubernetes、istio 延续这个策略，且不可更改
3. 证书过期之后，etcd停止工作，整个集群会退出服务
4. systemd-resolve 不稳定
5. renew后指定生成组件配置的时候,没有指定ip,会自动用了外网ip,实际上这时候kubernetes调度是瘫痪的状态,但是kubelet报错没权限
6. https://github.com/kubernetes/kubernetes/issues/77801
